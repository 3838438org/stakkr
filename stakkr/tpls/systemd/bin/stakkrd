#!/bin/bash
# This is a stakkr wrapper to run stakkr with a bash shell from outside the
# virtualenv. Run this as the stakkr user!
#

exec_command_in_stakkr() {
    cd $WDIR
    source $VIRTUALENV_DIR/bin/activate
    stakkr $1
    deactivate
}

sysconfdir="/etc"

if [[ $# -gt 0 ]] ; then
    key="$1"

    case $key in
        'start')
            COMMAND=$key
        ;;
        'stop')
            COMMAND=$key
        ;;
        'status')
            COMMAND=$key
        ;;
        *)    # unknown option
            COMMAND=""
            echo "Wrong input. Only Start, Stop and Status are supported via wrapper script."
        ;;
    esac
fi

if [ -n "$COMMAND" ]; then
    if test -f ${sysconfdir}/stakkr/stakkr.conf; then
        CONF_FILE=${sysconfdir}/stakkr/stakkr.conf
        . $CONF_FILE
        # take action on each file. $f store current file name
        exec_command_in_stakkr $COMMAND
    fi

    if test -d ${sysconfdir}/stakkr.d; then
        for CONF_FILE in ${sysconfdir}/stakkr.d/*.conf
        do
            if test -f $CONF_FILE ; then
              . $CONF_FILE
                  # take action on each file. $f store current file name
                exec_command_in_stakkr $COMMAND
            fi
        done
    fi
fi
